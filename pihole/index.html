<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>PiHole - My Docs</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "PiHole";
        var mkdocs_page_input_path = "pihole.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> My Docs
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../raid/">RAID</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../borg/">Borg</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../rclone/">RClone</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../kvm/">KVM</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">PiHole</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#enabling-transport-layer-security-tls">Enabling Transport Layer Security (TLS)</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#issue-tls-certificate-and-install">Issue TLS Certificate and Install</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#lighttpd-configuration-updates">Lighttpd Configuration Updates</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">My Docs</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">PiHole</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="pihole">PiHole</h1>
<h2 id="enabling-transport-layer-security-tls">Enabling Transport Layer Security (TLS)</h2>
<p>By default, the PiHole docker image utilizes http for communications through the browser. The http
protocol provides no protections from confidentiality perspective. As such, the login credentials
for the administrative interface are communicated in the clear. This allows an attacker with access
to the network communications to capture the passwords for the system.</p>
<p>The docker image can be configured to support Tranpsort Layer Security (TLS) so that all communications
with the service are encrypted and protected from tampering. The following is a high level overview of the
steps necessary to enable TLS</p>
<ol>
<li>Decide on a Domain for the DNS system (ns.domain.home for example)</li>
<li>Issue a TLS certificate off the appropriate certificate authority (see network-keying repository)</li>
<li>Reformat the TLS certificate and corresponding key so that PiHole able to understand</li>
<li>Update lighttpd configuration to enable TLS and find TLS certificate in container</li>
<li>Update docker and docker-compose to make TLS certificate available</li>
<li>Update docker-compose to allow port 443/tcp access externally (defaults to 80/tcp) </li>
<li>Navigate to https://ns.domain.home/admin to utilize web password to login</li>
</ol>
<h3 id="issue-tls-certificate-and-install">Issue TLS Certificate and Install</h3>
<p>The TLS certificate must come from a Certificate Authority (CA) that is trusted across all the clients/devices
in the network. The Root Certificate from the CA must be installed within the CA trust stores across all the devices
and browsers to enable support.</p>
<p>There are 2 primary mechanisms by which a TLS Certificate can be generated with differing levels of protection. The
first option is to generate a private/public key on the server that will be hosting the PiHole infrastructure. Once
generated, the private/public key should be utilized to generate a Certificate Signing Request (CSR). The CSR would
then be utilized with the CA's private key to generate a certificate. The benefit of this option is that the private
key associated with the certificate is known only to the machine that will be utilizing the certificate.</p>
<p>The second option is to leverage the infrastructure within the network-keying repository to generate a new certificate
and private key. The private key and certificate would then get uploaded, through secure channel, to the server that
will be hosting the PiHole infrastructure. Once transferred to the server, the copy of the private key on the machine
performing the generation should be securely deleted.</p>
<p>Once the private key and certificate are available, the files will need to be combined into a single file so that
lighttpd understand how to interpret the key and certificate. The following reference command can be utilized to
combined the files.</p>
<pre><code class="language-bash">cat ns.domain.home.key ns.domain.home.cert | tee ns.domain.home-combined.pem
</code></pre>
<p>The previous command utilizes the cat command to append the certificate to the end of the private key before
placing the results into a new file.</p>
<p>The TLS certificate/key needs to be installed into location where it can be bind-mounted into the docker
container. At the time of this writing, the certificates are being installed to <em>/opt/stark/certs</em> and permissions
adjusted for minimizing access.</p>
<h3 id="lighttpd-configuration-updates">Lighttpd Configuration Updates</h3>
<p>The lighttpd web server needs to be configured to enable TLS communications and be directed to the utilize the
TLS certificate. The lighttpd gets updated with various settings to enable the use of TLS but the one of interest
for pointing at the certificate is as follows:</p>
<pre><code>ssl.pemfile = &quot;/ssl/ns.domain.home-combined.pem&quot;
</code></pre>
<p>That line indicates the location within the docker container where the TLS certificate created in previous step must
be available. The lighttpd browser will utilize this path when attempting to perform TLS communications. The lighttpd-updates.conf
file within the network-services repository contains configurations that were made to enable support and restrict
ciphers appropriately.</p>
<h1 id="docker-and-docker-compose-updates">Docker and Docker Compose Updates</h1>
<p>By default, the PiHole application makes use of http for communications which means that port 80 is exposed. HTTPS is utilized
when the server supports TLS and the client connects securely. The HTTPS protocol requires that port 443 becomes available
on the container as well.</p>
<p>The docker-compose.yaml must be updated to include port 443 such as the following.</p>
<pre><code>    ports:
      - &quot;53:53/tcp&quot;
      - &quot;53:53/udp&quot;
      - &quot;80:80/tcp&quot;
      - &quot;443:443/tcp&quot;
</code></pre>
<p>Next, the docker-compose needs updated to include bind-mount for the TLS certificate so that it can be seen inside the container. The following
shows an example of that part.</p>
<pre><code>    volumes:
      - '/mnt/critical/dns/cfg:/etc/pihole'
      - '/mnt/critical/dns/dnsmasq:/etc/dnsmasq.d'
      - '/opt/stark/certs/ns.domain.home-combined.pem:/ssl/ns.domain.home-combined.pem:ro'
</code></pre>
<p>The last line in the previous snippet shows the bind-mount that provides that level of access. Finally, the docker build process was
updated to modify the lighttpd configuration file to enable TLS support. This last step is necessary so that lighttpd actually knows
to look for the certificate and enable TLS.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../kvm/" class="btn btn-neutral float-left" title="KVM"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../kvm/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
